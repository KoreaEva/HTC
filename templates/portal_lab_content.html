<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ë© ì½˜í…ì¸  ë³´ê¸°</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #f5f5f5;
            margin: 0; /* ê¸°ë³¸ ë§ˆì§„ ì œê±° */
            padding: 0;
        }
        .breadcrumbs {
            padding: 15px 40px;
            background: #fff;
            border-bottom: 1px solid #eee;
            font-size: 0.95em;
            color: #555;
        }
        .breadcrumbs a {
            text-decoration: none;
            color: #007bff;
        }
        .breadcrumbs a:hover { text-decoration: underline; }
        .container {
            max-width: 1100px;
            margin: 20px auto 40px auto; /* ìƒë‹¨ ì—¬ë°± ì¶”ê°€ */
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            padding: 0;
            display: flex;
            min-height: 600px;
        }
        .sidebar {
            width: 300px;
            border-right: 1px solid #eee;
            padding: 30px 0 30px 30px;
            background: #fafbfc;
            position: sticky; /* ìŠ¤í¬ë¡¤ ì‹œ ê³ ì • */
            top: 0; /* ë·°í¬íŠ¸ ìƒë‹¨ì— ê³ ì • */
            height: 100vh; /* ë·°í¬íŠ¸ ì „ì²´ ë†’ì´ */
            overflow-y: auto; /* ë‚´ìš©ì´ ê¸¸ë©´ ìŠ¤í¬ë¡¤ë°” ìƒì„± */
            box-sizing: border-box; /* íŒ¨ë”©ì„ ë„ˆë¹„ì— í¬í•¨ */
        }
        .sidebar h2 { font-size: 1.2em; margin-bottom: 18px; color: #007bff; }
        .content-list { list-style: none; padding: 0; margin: 0; }
        .content-list li { padding: 10px 0; cursor: pointer; border-bottom: 1px solid #f0f0f0; color: #333; }
        .content-list li.selected { background: #e6f0ff; color: #007bff; font-weight: bold; }
        .content-list li:hover { background: #f0f6ff; }
        .content-list li.disabled-content {
            color: #aaa; /* ë¹„í™œì„±í™”ëœ ì½˜í…ì¸  ìƒ‰ìƒ */
            cursor: not-allowed; /* í´ë¦­ ë¶ˆê°€ëŠ¥ ì»¤ì„œ */
            background-color: #f8f8f8; /* ë°°ê²½ìƒ‰ ë³€ê²½ */
        }
        .content-list li.disabled-content:hover { background-color: #f8f8f8; }
        .main-content { flex: 1; padding: 40px; min-width: 0; }
        .markdown-body { 
            font-size: 1.1em; 
            line-height: 1.7; 
            color: #222; 
            max-width: 100%;
        }
        .markdown-body h1, .markdown-body h2, .markdown-body h3, .markdown-body h4, .markdown-body h5, .markdown-body h6 {
            margin-top: 24px;
            margin-bottom: 16px;
            font-weight: 600;
            line-height: 1.25;
        }
        .markdown-body h1 { font-size: 2em; border-bottom: 1px solid #eaecef; padding-bottom: 0.3em; }
        .markdown-body h2 { font-size: 1.5em; border-bottom: 1px solid #eaecef; padding-bottom: 0.3em; }
        .markdown-body h3 { font-size: 1.25em; }
        .markdown-body p { margin-bottom: 16px; }
        .markdown-body ul, .markdown-body ol { padding-left: 2em; margin-bottom: 16px; }
        .markdown-body li { margin-bottom: 0.25em; }
        .markdown-body blockquote { 
            padding: 0 1em; 
            color: #6a737d; 
            border-left: 0.25em solid #dfe2e5; 
            margin: 0 0 16px 0;
        }
        .markdown-body pre { 
            background: #f6f8fa; 
            padding: 16px; 
            border-radius: 6px; 
            overflow-x: auto;
            margin-bottom: 16px;
        }
        .markdown-body code { 
            background: #f6f8fa; 
            padding: 0.2em 0.4em; 
            border-radius: 3px; 
            font-size: 85%;
        }
        .markdown-body pre code {
            background: none;
            padding: 0;
            border-radius: 0;
        }
        .markdown-body table {
            border-collapse: collapse;
            width: 100%;
            margin-bottom: 16px;
        }
        .markdown-body table th,
        .markdown-body table td {
            padding: 6px 13px;
            border: 1px solid #dfe2e5;
        }
        .markdown-body table th {
            background-color: #f6f8fa;
            font-weight: 600;
        }
        .markdown-body img {
            max-width: 100%;
            height: auto;
        }
        .markdown-body a {
            color: #0366d6;
            text-decoration: none;
        }
        .markdown-body a:hover {
            text-decoration: underline;
        }
        .back-btn { margin-bottom: 20px; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
        // ë§ˆí¬ë‹¤ìš´ íŒŒì„œ ì„¤ì •
        marked.setOptions({
            breaks: true,  // ì¤„ë°”ê¿ˆì„ <br>ë¡œ ë³€í™˜
            gfm: true,     // GitHub Flavored Markdown ì§€ì›
            sanitize: false // HTML íƒœê·¸ í—ˆìš© (XSS ë°©ì§€ëŠ” ì„œë²„ì—ì„œ ì²˜ë¦¬)
        });
    </script>
</head>
<body>
    <div class="breadcrumbs">
        <a href="/portal">í™ˆ</a>
        <span id="breadcrumbCourse"></span>
        <span id="breadcrumbLab"></span>
    </div>
    <div class="container">
        <div class="sidebar">
            <button class="back-btn button" onclick="window.history.back()">â† ë’¤ë¡œê°€ê¸°</button>
            <h2>ì½˜í…ì¸  ëª©ë¡</h2>
            <ul class="content-list" id="contentList"></ul>
        </div>
        <div class="main-content">
            <h2 id="contentTitle">ì½˜í…ì¸  ë³´ê¸°</h2>
            <div id="contentBody" class="markdown-body" style="margin-top:20px;"></div>
        </div>
    </div>
    <script>
        function getQueryParam(name) {
            const url = new URL(window.location.href);
            return url.searchParams.get(name);
        }
        const trainingKey = getQueryParam('training_key');
        const labId = getQueryParam('lab_id');
        const memberId = getQueryParam('member_id'); // Assuming member_id is also passed as a query parameter
        let contents = [];
        let selectedIdx = -1; // ì´ˆê¸° ì„ íƒ ì¸ë±ìŠ¤ë¥¼ -1ë¡œ ì„¤ì •

        // Function to load user info and then titles and contents
        async function fetchUserInfoAndLoadContents() {
            if (!trainingKey || !labId || !memberId) { 
                alert('íŠ¸ë ˆì´ë‹ í‚¤, ë© ID, ê·¸ë¦¬ê³  ë©¤ë²„ IDê°€ í•„ìš”í•©ë‹ˆë‹¤.');
                window.location.href = '/portal'; // Or appropriate fallback
                return;
            }

            try {
                // Fetch user info to get member_id (and verify if needed, though memberId is already from URL)
                const userInfoRes = await fetch(`/api/portal-info?training_key=${trainingKey}&member_id=${memberId}`);
                if (!userInfoRes.ok) {
                    const errorData = await userInfoRes.json();
                    throw new Error(errorData.detail || 'ì‚¬ìš©ì ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
                // const userInfo = await userInfoRes.json(); // If you need to use userInfo data beyond just memberId

                // Fetch course name
                const courseRes = await fetch(`/api/admin/courses/${trainingKey}`);
                let courseName = 'ì•Œ ìˆ˜ ì—†ëŠ” ê³¼ì •';
                if (courseRes.ok) {
                    const courseData = await courseRes.json();
                    courseName = courseData.course_name;
                }

                // Fetch lab name
                const labRes = await fetch(`/api/admin/labs/${labId}`);
                let labName = 'ì•Œ ìˆ˜ ì—†ëŠ” ë©';
                if (labRes.ok) {
                    const labData = await labRes.json();
                    labName = labData.lab_name;
                }

                // Update breadcrumbs
                document.getElementById('breadcrumbCourse').innerHTML = ` &gt; <a href="/portal" style="text-decoration: none; color: #007bff;">${courseName}</a>`;
                document.getElementById('breadcrumbLab').innerHTML = ` &gt; ${labName}`;

                // Load contents for the lab
                const res = await fetch(`/api/admin/lab_contents?training_key=${trainingKey}&lab_id=${labId}`);
                contents = await res.json();
                
                // view_numberë¡œ ì •ë ¬
                contents.sort((a, b) => a.view_number - b.view_number);
                
                const list = document.getElementById('contentList');
                list.innerHTML = '';
                contents.forEach((c, idx) => {
                    const li = document.createElement('li');
                    li.textContent = c.lab_content_subject;
                    
                    // ì½˜í…ì¸  ìƒíƒœê°€ 1(í™œì„±í™”)ì¸ ê²½ìš°ì—ë§Œ í´ë¦­ ê°€ëŠ¥í•˜ê²Œ ì„¤ì •
                    if (c.lab_content_status === 1) {
                        li.onclick = () => selectContent(idx);
                    } else {
                        li.classList.add('disabled-content');
                    }
                    list.appendChild(li);
                });
                
                // ì²« ë²ˆì§¸ í™œì„±í™”ëœ ì½˜í…ì¸ ë¥¼ ìë™ìœ¼ë¡œ ì„ íƒí•˜ê±°ë‚˜, í™œì„±í™”ëœ ì½˜í…ì¸ ê°€ ì—†ìœ¼ë©´ ë¹„ì›ë‹ˆë‹¤.
                const firstActiveContentIdx = contents.findIndex(c => c.lab_content_status === 1);
                if (firstActiveContentIdx !== -1) {
                    // selectContent(firstActiveContentIdx); // ìë™ ì„ íƒ ì œê±°
                    list.children[firstActiveContentIdx].classList.add('initial-selection'); // ì´ˆê¸° ì„ íƒ í‘œì‹œìš© í´ë˜ìŠ¤ ì¶”ê°€
                    document.getElementById('contentTitle').textContent = "ì½˜í…ì¸ ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.";
                    document.getElementById('contentBody').innerHTML = '<p style="color:#555;">ì™¼ìª½ ëª©ë¡ì—ì„œ ì½˜í…ì¸ ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.</p>';
                } else {
                    document.getElementById('contentTitle').textContent = "ì½˜í…ì¸ ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
                    document.getElementById('contentBody').innerHTML = '<p style="color:#555;">í˜„ì¬ í™œì„±í™”ëœ ì½˜í…ì¸ ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                }
            } catch (error) {
                console.error('Error loading titles or contents:', error);
                alert(`í˜ì´ì§€ ë¡œë“œ ì‹¤íŒ¨: ${error.message}`);
            }
        }

        async function selectContent(idx) {
            const content = contents[idx];

            // í™œì„±í™”ë˜ì§€ ì•Šì€ ì½˜í…ì¸ ëŠ” ì„ íƒí•  ìˆ˜ ì—†ìŒ
            if (content.lab_content_status !== 1) {
                document.getElementById('contentTitle').textContent = "ë¹„í™œì„±í™”ëœ ì½˜í…ì¸ ";
                document.getElementById('contentBody').innerHTML = '<p style="color:red;">ì´ ì½˜í…ì¸ ëŠ” í˜„ì¬ í™œì„±í™”ë˜ì–´ ìˆì§€ ì•Šì•„ ë³¼ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }

            selectedIdx = idx;
            document.querySelectorAll('.content-list li').forEach((li, i) => {
                li.classList.toggle('selected', i === idx);
            });
            document.getElementById('contentTitle').textContent = content.lab_content_subject;
            const bodyDiv = document.getElementById('contentBody');
            
            // ì½˜í…ì¸  íƒ€ì…ì— ë”°ë¼ ë‹¤ë¥´ê²Œ ì²˜ë¦¬
            const contentText = content.lab_content || '(ë‚´ìš© ì—†ìŒ)';
            
            if (content.lab_content_type === 0) {
                // íƒ€ì… 0: URL ê¸°ë°˜ ë§ˆí¬ë‹¤ìš´ ì²˜ë¦¬
                if (contentText.startsWith('http://') || contentText.startsWith('https://')) {
                    try {
                        const res = await fetch(`/api/proxy-markdown?url=${encodeURIComponent(contentText)}`);
                        if (res.ok) {
                            const md = await res.text();
                            bodyDiv.innerHTML = marked.parse(md);
                        } else {
                            bodyDiv.innerHTML = '<span style="color:red">ë§ˆí¬ë‹¤ìš´ ì½˜í…ì¸ ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</span>';
                        }
                    } catch (e) {
                        bodyDiv.innerHTML = '<span style="color:red">ë§ˆí¬ë‹¤ìš´ ì½˜í…ì¸ ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ ë°œìƒ.</span>';
                    }
                } else {
                    bodyDiv.innerHTML = '<span style="color:red">ìœ íš¨í•˜ì§€ ì•Šì€ ë§ˆí¬ë‹¤ìš´ URLì…ë‹ˆë‹¤.</span>';
                }
            } else if (content.lab_content_type === 2) {
                // íƒ€ì… 2: Text(Markdown) ì²˜ë¦¬ - ì§ì ‘ ì…ë ¥ëœ ë§ˆí¬ë‹¤ìš´ í…ìŠ¤íŠ¸
                bodyDiv.innerHTML = marked.parse(contentText);
            } else if (content.lab_content_type === 1) {
                // íƒ€ì… 1: ì›¹í˜ì´ì§€ ë§í¬ ë²„íŠ¼
                if (contentText.startsWith('http://') || contentText.startsWith('https://')) {
                    bodyDiv.innerHTML = `
                        <div style="text-align: center; padding: 40px 20px;">
                            <div style="margin-bottom: 20px;">
                                <p style="font-size: 1.1em; color: #555; margin-bottom: 10px;">ì´ ì½˜í…ì¸ ëŠ” ì™¸ë¶€ ì›¹í˜ì´ì§€ì…ë‹ˆë‹¤.</p>
                                <p style="color: #888; margin-bottom: 30px;">ì•„ë˜ ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ì›¹í˜ì´ì§€ë¥¼ í™•ì¸í•˜ì„¸ìš”.</p>
                            </div>
                            <a href="${contentText}" target="_blank" style="
                                display: inline-block;
                                background: #007bff;
                                color: white;
                                padding: 15px 30px;
                                border-radius: 8px;
                                text-decoration: none;
                                font-weight: 600;
                                font-size: 1.1em;
                                transition: background-color 0.3s ease;
                                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                            " onmouseover="this.style.background='#0056b3'" onmouseout="this.style.background='#007bff'">
                                ğŸŒ ì›¹í˜ì´ì§€ ì—´ê¸°
                            </a>
                            <div style="margin-top: 20px; font-size: 0.9em; color: #888;">
                                <p>ë§í¬: <a href="${contentText}" target="_blank" style="color: #007bff; text-decoration: underline;">${contentText}</a></p>
                            </div>
                        </div>
                    `;
                } else {
                    bodyDiv.innerHTML = '<span style="color:red">ì›¹í˜ì´ì§€ URLì´ ì•„ë‹™ë‹ˆë‹¤.</span>';
                }
            } else {
                // ê¸°íƒ€ íƒ€ì…: ê¸°ë³¸ í…ìŠ¤íŠ¸ ì²˜ë¦¬
                bodyDiv.innerHTML = `<pre style="background: #f6f8fa; padding: 16px; border-radius: 6px; overflow-x: auto;">${contentText}</pre>`;
            }

            // Log the content view
            try {
                const logData = {
                    training_key: trainingKey,
                    member_id: memberId, 
                    lab_id: parseInt(labId),
                    content_id: content.content_id
                };
                console.log('Attempting to log content view with data:', logData);
                const logRes = await fetch('/api/portal/log_content_view', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(logData)
                });
                if (!logRes.ok) {
                    const errorData = await logRes.json();
                    console.error('Failed to log content view. Server response:', logRes.status, logRes.statusText, errorData);
                } else {
                    console.log('Content view logged successfully.');
                }
            } catch (error) {
                console.error('Error logging content view:', error);
            }
        }
        
        fetchUserInfoAndLoadContents(); // í˜ì´ì§€ ë¡œë“œì‹œ ì‚¬ìš©ì ì •ë³´ ë° ì œëª©ê³¼ ì½˜í…ì¸ ë¥¼ í•¨ê»˜ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤.
    </script>
</body>
</html> 